# .github/workflows/deployment.yml
name: Deploy Image

on:
  workflow_call:
    inputs:
      image_tag:
        required: true
        type: string
      container_name:
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      EC2_HOST:
        required: true
      EC2_USERNAME:
        required: true
      DATABASE_URL:
        required: true
      DOCKER_REPO:
        required: true

jobs:
    deploy:
      runs-on: ubuntu-latest
      environment: sites
      steps:
        - name: Deployment
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              CONTAINER_NAME="${{ inputs.container_name }}"
              IMAGE_TAG="${{ secrets.DOCKER_REPO }}:${{ inputs.image_tag }}"
              
              docker stop "${CONTAINER_NAME}" || true
              docker rm "${CONTAINER_NAME}" || true
              docker pull "$IMAGE_TAG"

              # Generate random port antara 5000 dan 8500
              while :
              do
                PORT_HOST=$(( ( RANDOM % 3500 ) + 5000 ))
                if ! ss -tuln | grep -q ":$PORT_HOST "; then
                  break
                fi
              done
              echo "Random available port selected: $PORT_HOST"

              docker run -d \
                -p ${PORT_HOST}:${{ vars.PORT }} \
                --network tunnel \
                --name "${CONTAINER_NAME}" \
                -e NODE_ENV="production" \
                -e PORT="${{ vars.PORT }}" \
                -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                --restart unless-stopped \
                "$IMAGE_TAG"
              echo "Deployment completed successfully."
              
              docker image prune -f
              echo "Old images pruned."